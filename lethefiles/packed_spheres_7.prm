#=================================================================================================
# Simulating fluid flowing over a dense particle packing. This file contains the baked in 
# settings that are appended by the requisite particle properties. Particles are placed in the
# box shown below.
#           
#        +------+.      
#        |`.    | `.      
#        |  `+--+---+   
#        |   |  |   |    
#        +---+--+.  |    x\ |z
#         `. |    `.|      \|
#           `+------+       +---y
#
# Fluid enters from -x, leaving through +x. Periodic boundaries are set for y and z               
#
# Volume fraction = 0.04464301117704429, Reynolds number = 62.5375
# Author:   Daniel Weston <dtw545@student.bham.ac.uk>
# Date:     06.03.2022
# License:  MIT
#=================================================================================================


#-------------------------------------------------------------------------------------------------
# Simulation and IO Control
#-------------------------------------------------------------------------------------------------
subsection simulation control
    set method                          = bdf2
    set bdf startup method              = multiple step bdf

    set time step                       = 0.0001                # Time step
    set time end                        = 18.17551048773302 ###
    set adapt                           = true
    set max cfl                         = 0.8
    set adaptative time step scaling    = 1.1

    set output name                     = packed_spheres        # Prefix for VTU outputs
    set output path                     = ./results/            # Output directory
    set output boundaries               = true                  # Output domain boundaries
    set output frequency                = 1                     # Frequency of simulation output
    set subdivision                     = 1                     # Output mesh subdivision
end


#-------------------------------------------------------------------------------------------------
# Simulation Checkpointing
#-------------------------------------------------------------------------------------------------
subsection restart
    set checkpoint                      = true                  # Enable checkpointing
    set restart                         = false                 # Start from previous checkpoint
    set filename                        = restart
    set frequency                       = 10
end


#-------------------------------------------------------------------------------------------------
# Force
#-------------------------------------------------------------------------------------------------
subsection forces
    set verbosity                       = verbose
    set calculate force                 = true
    set force name                      = force
    set calculate torque                = true
    set torque name                     = torque

    set output precision                = 15
    set calculation frequency           = 1
    set output frequency                = 1
end


#-------------------------------------------------------------------------------------------------
# FEM
#-------------------------------------------------------------------------------------------------
subsection FEM
    set velocity order                  = 1
    set pressure order                  = 1
    set qmapping all                    = false
end


#-------------------------------------------------------------------------------------------------
# Physical Properties
#-------------------------------------------------------------------------------------------------
subsection physical properties
    subsection fluid 0
        set kinematic viscosity = 0.000001 # water
    end
end


#-------------------------------------------------------------------------------------------------
# Timer
#-------------------------------------------------------------------------------------------------
subsection timer
    set type                            = iteration
end


#-------------------------------------------------------------------------------------------------
# Mesh
#-------------------------------------------------------------------------------------------------
subsection mesh
    # Automatically generate mesh using deal.II's functions:
    # https://www.dealii.org/current/doxygen/deal.II/namespaceGridGenerator.html
    set type                            = dealii
    set grid type                       = subdivided_hyper_rectangle
    set grid arguments                  = 4, 4, 4 : -0.01,-0.01,-0.01 : 0.01,0.01,0.01 : true
    set initial refinement              = 5
end

#-------------------------------------------------------------------------------------------------
# Mesh Adaptation Control
#-------------------------------------------------------------------------------------------------
subsection mesh adaptation
    set fraction coarsening     = 0.01
    set fraction refinement     = 0.01

    set fraction type           = number
    set frequency               = 1
    set max number elements     = 2500000
    set max refinement level    = 8
    set min refinement level    = 4

    set type                    = kelly
    set variable                = pressure
end


#-------------------------------------------------------------------------------------------------
# Non-Linear Solver Control
#-------------------------------------------------------------------------------------------------
subsection non-linear solver
    set verbosity               = verbose
    set solver                  = newton
    set max iterations          = 10
    set tolerance               = 1e-5
end


#-------------------------------------------------------------------------------------------------
# Linear Solver Control
#-------------------------------------------------------------------------------------------------
subsection linear solver
    set verbosity                                   = verbose

    # GMRES linear solver, good for < 1,000,000 elements
    set method                                      = gmres
    set max iters                                   = 5000
    set max krylov vectors                          = 1000
    set relative residual                           = 1e-3
    set minimum residual                            = 1e-10
    set ilu preconditioner fill                     = 1
    set ilu preconditioner absolute tolerance       = 1e-12
    set ilu preconditioner relative tolerance       = 1.00

    # AMG linear solver, more efficient for > 1,000,000 elements
    # set method                                      = amg
    # set max iters                                   = 1000
    # set max krylov vectors                          = 1000
    # set relative residual                           = 1e-3
    # set minimum residual                            = 1e-10
    # set amg preconditioner ilu fill                 = 0
    # set amg preconditioner ilu absolute tolerance   = 1e-20
    # set amg preconditioner ilu relative tolerance   = 1.00
    # set amg aggregation threshold                   = 1e-12
    # set amg n cycles                                = 1
    # set amg w cycles                                = false
    # set amg smoother sweeps                         = 2
    # set amg smoother overlap                        = 1
end

#-------------------------------------------------------------------------------------------------
# Initial condition
#-------------------------------------------------------------------------------------------------
subsection initial conditions
    set type = nodal
    subsection uvwp
        set Function expression         = 0.0125075;0;0;0
    end
end

#-------------------------------------------------------------------------------------------------
# Boundary Conditions
#-------------------------------------------------------------------------------------------------
subsection boundary conditions
    # Box hull, xmin, xmax, ymin, ymax, zmin, zmax = boundary ID 0, 1, 2, 3, 4, 5
    set number                  = 3
    subsection bc 0 # inlet
        set id                  = 0
        set type                = function
        subsection u
          set Function expression = 0.0125075
        end
        subsection v
            set Function expression = 0
        end
        subsection w
            set Function expression = 0
        end
    end

    subsection bc 1 # periodic y walls
        set id                  = 2
        set type                = periodic
        set periodic_id         = 3
        set periodic_direction  = 1
    end

    subsection bc 2 # periodic z walls
        set id                  = 4
        set type                = periodic
        set periodic_id         = 5
        set periodic_direction  = 2
    end
end

subsection particles
    set stencil order                           = 6                     # Sphere interpolation
    set length ratio                            = 4                     # 2 * Q * aspect ratio
    # set particle nonlinear tolerance            = 1e-3
    set alpha                                   = 1

    set calculate force                         = true
    set ib force output file                    = spheres_force
    set ib particles pvd file                   = spheres_data

    set initial refinement                      = 1
    set refine mesh inside radius factor        = 0
    set refine mesh outside radius factor       = 2

    set integrate motion                        = false
    set assemble Navier-Stokes inside particles = false

        set number of particles                     = 38
    subsection particle info 0
        set density                             = 1
        subsection position
            set Function expression             = -0.0005211823226516981;0.0004887031929049187;0.0036345631529738015
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000763
    end
    subsection particle info 1
        set density                             = 1
        subsection position
            set Function expression             = 0.0038578395493597912;-0.0012906939099965125;-0.0026925453113822943
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000763
    end
    subsection particle info 2
        set density                             = 1
        subsection position
            set Function expression             = -0.003609048402220499;0.0027235038800740166;0.003929712403998577
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000763
    end
    subsection particle info 3
        set density                             = 1
        subsection position
            set Function expression             = -0.003323625995928247;-0.0001821135660550156;-0.0007827046866448152
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 4
        set density                             = 1
        subsection position
            set Function expression             = -0.0021976880576450785;0.0034568151591610223;-0.001307619980679648
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 5
        set density                             = 1
        subsection position
            set Function expression             = 0.0028309847171562657;0.00036014124535030737;0.0028939106026170365
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 6
        set density                             = 1
        subsection position
            set Function expression             = -0.0020445018154776197;-0.0019420127323558612;0.0005920072950385546
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 7
        set density                             = 1
        subsection position
            set Function expression             = -0.0001333922870147006;-0.0019241678560730853;0.0005108429796578558
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 8
        set density                             = 1
        subsection position
            set Function expression             = -0.0042620408904096305;-0.0021212451146548823;-0.0017666420046084756
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 9
        set density                             = 1
        subsection position
            set Function expression             = -0.0019521714546494985;-0.000145638294120151;0.0022571907226262566
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 10
        set density                             = 1
        subsection position
            set Function expression             = -0.003395524820497038;0.0014143419062785535;0.0008444188236465767
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 11
        set density                             = 1
        subsection position
            set Function expression             = 0.0021471690280116954;-0.0025301462074416438;-0.004167308471709168
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 12
        set density                             = 1
        subsection position
            set Function expression             = 4.6515984016710574e-05;0.0017941433688598418;0.004167600427366607
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 13
        set density                             = 1
        subsection position
            set Function expression             = 0.003854769318762593;-0.00289205955708961;0.003155023994927771
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 14
        set density                             = 1
        subsection position
            set Function expression             = -0.003511717248946297;-0.001431803040407506;-0.004313700128958421
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 15
        set density                             = 1
        subsection position
            set Function expression             = -0.00035806740417986503;0.0019611379490052996;0.0008455089320640588
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 16
        set density                             = 1
        subsection position
            set Function expression             = 0.0004686212006344559;-0.0038834809367002364;0.0003358968791253381
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 17
        set density                             = 1
        subsection position
            set Function expression             = 0.0021157942885140857;0.00015460705624642176;-0.0015192056663889462
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 18
        set density                             = 1
        subsection position
            set Function expression             = -0.0013023671350918557;0.0011155605111809264;-0.0007744885821707962
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 19
        set density                             = 1
        subsection position
            set Function expression             = -0.0022025373145949734;0.0019553536022805396;0.0036279935290235996
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 20
        set density                             = 1
        subsection position
            set Function expression             = 0.002676833350060895;-0.0004618855265257349;-0.0029100443180231582
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 21
        set density                             = 1
        subsection position
            set Function expression             = 2.728153487075065e-06;-0.004147924342727254;-0.004164428216947442
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 22
        set density                             = 1
        subsection position
            set Function expression             = -0.0015450422356580581;0.0024751452950179317;-0.00023302663361328933
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 23
        set density                             = 1
        subsection position
            set Function expression             = 0.003521368861441206;0.003646454242359127;-0.004043548670151992
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 24
        set density                             = 1
        subsection position
            set Function expression             = 0.003810078133274838;-0.004016814049806825;-0.0005937351033062374
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 25
        set density                             = 1
        subsection position
            set Function expression             = 0.0010941187320715378;-0.0011464700736787499;0.0012774716812546695
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000672
    end
    subsection particle info 26
        set density                             = 1
        subsection position
            set Function expression             = 0.0004665468472365977;0.0012528615054920597;-0.0031566771949439673
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000591
    end
    subsection particle info 27
        set density                             = 1
        subsection position
            set Function expression             = -0.0042736154232516955;0.003345581408751003;-0.0008132631219053936
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000591
    end
    subsection particle info 28
        set density                             = 1
        subsection position
            set Function expression             = -0.0008318745046071128;-0.0013147989317378022;0.002174354282754638
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000591
    end
    subsection particle info 29
        set density                             = 1
        subsection position
            set Function expression             = 0.004372430257206982;-0.002564667122235832;-0.004360323417633922
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000591
    end
    subsection particle info 30
        set density                             = 1
        subsection position
            set Function expression             = 0.002689435201552434;0.0013374324917501922;-0.0017721111545209362
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000591
    end
    subsection particle info 31
        set density                             = 1
        subsection position
            set Function expression             = -0.00387217403336995;0.00037102115124977315;-0.004247510945074032
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000591
    end
    subsection particle info 32
        set density                             = 1
        subsection position
            set Function expression             = -0.002636254652233913;0.002468059904625667;0.0006828170435888769
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000591
    end
    subsection particle info 33
        set density                             = 1
        subsection position
            set Function expression             = 0.001657174167529295;0.0021262336648657145;-0.004390794601939058
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000591
    end
    subsection particle info 34
        set density                             = 1
        subsection position
            set Function expression             = 0.003915125210264291;0.0015094089119273282;-0.0013644172373993404
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000591
    end
    subsection particle info 35
        set density                             = 1
        subsection position
            set Function expression             = 0.0001576394052978788;-0.000554515158550122;0.00026373024809347913
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.000591
    end
    subsection particle info 36
        set density                             = 1
        subsection position
            set Function expression             = 0.004243394909074248;-0.0012617631891098636;0.0035460806305269163
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.00052
    end
    subsection particle info 37
        set density                             = 1
        subsection position
            set Function expression             = -0.0010228427341314236;-0.0009178325468291683;0.003988385442173287
        end
        subsection velocity
            set Function expression             = 0;0;0
        end
        set radius                              = 0.00052
    end
end